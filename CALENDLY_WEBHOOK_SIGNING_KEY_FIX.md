# Calendly Webhook Signing Key Fix

## üîç **The Problem You Identified**

You were absolutely right! There are **TWO different signing keys**:

1. **Developer App Signing Key** (from Calendly dashboard)
   - `2IrkZDJS2tZIbW8ZrFqQDii8BxWw7jggw4YBJURAo0Y`
   - Stored in `CALENDLY_WEBHOOK_SIGNING_KEY` environment variable
   - This is NOT used for webhook verification

2. **Webhook Subscription Signing Key** (returned by Calendly API)
   - Generated by Calendly when you create a webhook
   - Returned in the webhook creation response
   - This IS used for webhook verification
   - Each webhook has its own unique signing key

## ‚úÖ **What Was Fixed**

### Code Changes:

1. **`backend/src/services/calendlyWebhookService.js`**
   - ‚ùå Removed: Sending developer app signing key when creating webhooks
   - ‚úÖ Added: Capturing and returning the signing key from Calendly's response
   - ‚úÖ Added: Storing webhook signing key in database

2. **`backend/src/routes/calendar.js`**
   - ‚úÖ Added: Storing `calendly_webhook_signing_key` in `calendar_connections` table

3. **`backend/src/routes/calendly-webhook.js`**
   - ‚ùå Removed: Using environment variable for verification
   - ‚úÖ Added: Fetching signing keys from database
   - ‚úÖ Added: Trying all active webhooks to find the correct key
   - ‚úÖ Added: Proper error handling

## üìä **Database Changes Required**

You need to add TWO new columns:

### 1. `calendar_connections` table
```sql
ALTER TABLE calendar_connections
ADD COLUMN IF NOT EXISTS calendly_webhook_signing_key TEXT;
```

### 2. `calendly_webhook_subscriptions` table
```sql
ALTER TABLE calendly_webhook_subscriptions
ADD COLUMN IF NOT EXISTS webhook_signing_key TEXT;
```

## üöÄ **How to Apply**

1. Go to Supabase SQL Editor
2. Copy and paste this SQL:

```sql
-- Add webhook signing key column to calendar_connections
ALTER TABLE calendar_connections
ADD COLUMN IF NOT EXISTS calendly_webhook_signing_key TEXT;

-- Add webhook signing key column to calendly_webhook_subscriptions
ALTER TABLE calendly_webhook_subscriptions
ADD COLUMN IF NOT EXISTS webhook_signing_key TEXT;

-- Verify columns were added
SELECT column_name, data_type 
FROM information_schema.columns
WHERE table_name IN ('calendar_connections', 'calendly_webhook_subscriptions')
AND column_name LIKE '%signing_key%';
```

3. Click "Run"
4. Verify you see the new columns in the output

## üß™ **Testing After Migration**

1. Commit and push code changes
2. Wait for Render deployment
3. Go to Settings ‚Üí Calendar Integrations
4. Disconnect Calendly (if connected)
5. Reconnect Calendly with OAuth
6. Check Render logs for:
   ```
   üì° Setting up Calendly webhook subscription...
   üîë Webhook signing key received from Calendly: ...
   ‚úÖ Webhook ID stored in calendar_connections
   üîë Webhook signing key stored for verification
   ```
7. Create a test meeting in Calendly
8. Verify it syncs to Advicly within 5 seconds

## üìù **What Each Column Does**

### `calendar_connections.calendly_webhook_signing_key`
- Stores the signing key for this user's webhook
- Used when verifying incoming webhook events
- Unique per user/webhook subscription

### `calendly_webhook_subscriptions.webhook_signing_key`
- Stores the signing key for the webhook subscription
- Backup/reference for webhook verification
- Allows multiple webhooks to be verified independently

