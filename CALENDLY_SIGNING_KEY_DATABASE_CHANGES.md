# Calendly Webhook Signing Key Fix - Database Changes Required

## üéØ **The Issue You Identified**

You were absolutely correct! There are **TWO different signing keys**:

1. **Developer App Signing Key** (from Calendly dashboard)
   - This is NOT used for webhook verification
   - The code was incorrectly sending this to Calendly

2. **Webhook Subscription Signing Key** (returned by Calendly API)
   - Generated by Calendly when you create a webhook
   - This IS used for webhook verification
   - Each webhook has its own unique key

## ‚úÖ **Code Changes (Already Committed)**

**Commit: `02d8255`**

- ‚ùå Removed: Sending developer app key when creating webhooks
- ‚úÖ Added: Capturing Calendly's returned signing key
- ‚úÖ Added: Storing signing key in database
- ‚úÖ Added: Using database keys for webhook verification

## üìä **Database Changes YOU NEED TO MAKE**

### Two New Columns Required:

1. **`calendar_connections.calendly_webhook_signing_key`**
   - Stores the signing key for this user's webhook
   - Used to verify incoming webhook events

2. **`calendly_webhook_subscriptions.webhook_signing_key`**
   - Backup storage of the signing key
   - Allows multiple webhooks to be verified independently

## üöÄ **How to Apply**

### Step 1: Open Supabase SQL Editor
- Go to https://app.supabase.com
- Select your Advicly project
- Click "SQL Editor" ‚Üí "New Query"

### Step 2: Run This SQL

```sql
ALTER TABLE calendar_connections
ADD COLUMN IF NOT EXISTS calendly_webhook_signing_key TEXT;

ALTER TABLE calendly_webhook_subscriptions
ADD COLUMN IF NOT EXISTS webhook_signing_key TEXT;

-- Verify columns were added
SELECT column_name, data_type
FROM information_schema.columns
WHERE table_name IN ('calendar_connections', 'calendly_webhook_subscriptions')
AND column_name LIKE '%signing_key%'
ORDER BY table_name;
```

### Step 3: Verify
You should see both new columns listed.

## üß™ **Testing After Database Update**

1. Wait for Render deployment (~2 min)
2. Disconnect Calendly (Settings ‚Üí Calendar Integrations)
3. Reconnect Calendly (OAuth flow)
4. Check Render logs for:
   ```
   üîë Webhook signing key received from Calendly
   üîë Webhook signing key stored for verification
   ```
5. Create test meeting in Calendly
6. Verify it syncs within 5 seconds

## ‚ö†Ô∏è **Important Notes**

- Environment variable `CALENDLY_WEBHOOK_SIGNING_KEY` is NO LONGER USED
- Each webhook has its own unique signing key from Calendly
- Code now fetches keys from database, not environment
- This is more secure and scalable

